<!-- views/make-payment.ejs -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Make Payment</title>
  <!-- Include Razorpay.js script -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body>
    <h1>Make Payment</h1>
  <form id="paymentForm" action="/user/<%= phone %>/order/<%= orderId %>/payment" method="post">
    <label for="amount">Amount:</label>
    <input type="number" id="amount" name="amount" required>
    <br>
    <label for="phone">phone no:</label>
    <input type="text" id="phone" name="phone" value="<%=phone%>" readonly>
    <br>
    <label for="orderId">orderId:</label>
    <input type="text" id="orderId" name="orderId" value="<%=orderId%>" readonly>
    <br>
    <button type="submit">Pay Now</button>
  </form>

  <script>
    // Function to initiate Razorpay payment
    function initiateRazorpayPayment(orderId, amount) {
      const options = {
        key: 'rzp_test_hz7exB8EYQbPhc',
        amount: amount * 100, // Amount in paise
        currency: 'INR',
        name: 'Your Company Name',
        description: 'Payment for Order',
        order_id: orderId,
        handler: function (response) {
          console.log('Payment successful:', response);
          // Handle the success response from Razorpay
        },
      };

      const rzp = new Razorpay(options);
      rzp.open();
    }

    // Fetch Razorpay order ID from the server and initiate payment
    window.addEventListener('load', async function () {
      const response = await fetch(`/user/${phone}/order/${orderId}/saveAmount`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ amount: 0 }), // Set a dummy amount, as it's not needed here
      });

      if (!response.ok) {
        console.error('Failed to fetch Razorpay order ID:', response.status);
        return;
      }

      const data = await response.json();
      console.log('Fetched Razorpay order ID:', data.razorpayOrderId);

      // Initiate Razorpay payment with the fetched order ID
      initiateRazorpayPayment(data.razorpayOrderId.id, 100); // Pass the actual amount
    });
  </script>
</body>

</html>
